<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registration Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="text-danger mb-4">Registration Details</h2>
    <a href="/registrar" class="btn btn-secondary mb-3">Back to Dashboard</a>
        <div class="mb-3">
                <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
                <form action="/registration/<%= registration.id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this registration?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                </form>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Edit Registration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                      <form action="/registration/<%= registration.id %>/edit" method="POST" enctype="multipart/form-data" id="editInfoForm">
                        <div class="modal-body">
                                        <!-- Learner's Personal Information -->
                                        <div class="border rounded p-3 mb-3">
                                            <h6 class="text-danger mb-3">Learner's Personal Information</h6>
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Last Name</label>
                                                    <input type="text" class="form-control" name="lastName" value="<%= registration.last_name %>" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">First/Given Name</label>
                                                    <input type="text" class="form-control" name="givenName" value="<%= registration.first_name %>" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Middle Name</label>
                                                    <input type="text" class="form-control" name="middleName" value="<%= registration.middle_name || '' %>">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Name Extension</label>
                                                    <input type="text" class="form-control" name="extName" value="<%= registration.ext_name || '' %>">
                                                </div>
                                            </div>
                                        </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">Gmail Address</label>
                                                    <input type="email" class="form-control" name="gmail" value="<%= registration.gmail_address %>" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">School Year</label>
                                                    <input type="text" class="form-control" name="schoolYear" value="<%= registration.school_year %>" required>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <label class="form-label">LRN</label>
                                                    <input type="text" class="form-control" name="lrn" value="<%= registration.lrn %>">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Printed Name</label>
                                                    <input type="text" class="form-control" name="printedName" value="<%= registration.printed_name %>" required>
                                                </div>
                                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Grade Level</label>
                                    <input type="text" class="form-control" name="gradeLevel" value="<%= registration.grade_level %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Birthday</label>
                                    <input type="date" class="form-control" name="birthday" value="<%= registration.birthday ? new Date(registration.birthday).toISOString().split('T')[0] : '' %>" required>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Age</label>
                                    <input type="number" class="form-control" name="age" value="<%= registration.age %>" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sex</label>
                                    <input type="text" class="form-control" name="sex" value="<%= registration.sex %>" required>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Religion</label>
                                    <input type="text" class="form-control" name="religion" value="<%= registration.religion %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Current Address</label>
                                    <input type="text" class="form-control" name="address" value="<%= registration.current_address %>">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">IP Community</label>
                                    <input type="text" class="form-control" name="ipCommunity" value="<%= registration.ip_community %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">IP Community Specify</label>
                                    <input type="text" class="form-control" name="ipCommunitySpecify" value="<%= registration.ip_community_specify %>">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">PWD</label>
                                    <input type="text" class="form-control" name="pwd" value="<%= registration.pwd %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">PWD Specify</label>
                                    <input type="text" class="form-control" name="pwdSpecify" value="<%= registration.pwd_specify %>">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Father's Name</label>
                                    <input type="text" class="form-control" name="fatherName" value="<%= registration.father_name %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Mother's Name</label>
                                    <input type="text" class="form-control" name="motherName" value="<%= registration.mother_name %>">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Legal Guardian's Name</label>
                                    <input type="text" class="form-control" name="guardianName" value="<%= registration.guardian_name %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contact Number</label>
                                    <input type="text" class="form-control" name="contactNumber" value="<%= registration.contact_number %>">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Registration Date</label>
                                    <input type="date" class="form-control" name="date" value="<%= registration.registration_date ? new Date(registration.registration_date).toISOString().split('T')[0] : '' %>" required>
                                </div>
                            </div>

                                            <!-- Signature section -->
                                            <div class="border rounded p-3 mt-3">
                                                <h6 class="text-danger mb-3">Signature</h6>
                                                <div class="mb-2">
                                                    <strong>Current Signature:</strong>
                                                    <% if (registration.signature_image_path) { %>
                                                        <div class="mt-2">
                                                            <img src="<%= registration.signature_image_path %>" alt="Signature" style="max-width:260px; border:1px solid #dc2626; border-radius:8px;" />
                                                        </div>
                                                    <% } else { %>
                                                        <div class="text-muted">No signature uploaded</div>
                                                    <% } %>
                                                </div>
                                                                <div class="form-check form-switch mt-2">
                                                    <input class="form-check-input" type="checkbox" id="changeSignatureSwitch">
                                                    <label class="form-check-label" for="changeSignatureSwitch">Change signature</label>
                                                </div>
                                                <input type="hidden" name="signatureData" id="signatureData">
                                                <div class="mt-2">
                                                                    <button type="button" id="openEsignBtn" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#signatureModal" disabled>Open E‑Sign Pad</button>
                                                                    <label class="btn btn-outline-secondary btn-sm ms-2 mb-0">
                                                                        Upload image <input type="file" id="signatureFile" name="signatureImage" accept="image/*" hidden disabled>
                                                                    </label>
                                                    <span id="esignStatus" class="ms-2 text-muted" style="font-size:0.9rem;">Keeping existing signature</span>
                                                </div>
                                                <div id="esignPreviewWrap" class="mt-2" style="display:none;">
                                                    <div class="text-success" style="font-size:0.9rem;">New signature selected:</div>
                                                    <img id="esignPreview" alt="New signature preview" style="max-width:260px; border:1px dashed #16a34a; border-radius:8px;" />
                                                </div>
                                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">Save Changes</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

                        <!-- E‑Sign Modal -->
                        <div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content" style="border-radius: 16px;">
                                    <div class="modal-header" style="border-bottom: 1px solid #dc2626;">
                                        <h5 class="modal-title text-danger" id="signatureModalLabel">Draw E‑Signature</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" style="padding: 1.25rem;">
                                        <div class="d-flex justify-content-center mb-2">
                                            <canvas id="signatureCanvas" width="480" height="180" style="background:#f8f9fa; border:2px solid #dc2626; border-radius:12px; box-shadow:0 2px 8px rgba(220,38,38,0.08);"></canvas>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSignatureBtn">Clear</button>
                                            <div>
                                                <button type="button" class="btn btn-outline-danger btn-sm me-2" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-danger btn-sm" id="doneSignatureBtn">Done</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    <div class="card">
        <div class="card-body">
            <h4 class="card-title mb-3"><%= registration.last_name %>, <%= registration.first_name %> <%= registration.middle_name %> <%= registration.ext_name %></h4>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>Gmail Address:</strong> <%= registration.gmail_address %></li>
                <li class="list-group-item"><strong>School Year:</strong> <%= registration.school_year %></li>
                <li class="list-group-item"><strong>LRN:</strong> <%= registration.lrn %></li>
                <li class="list-group-item"><strong>Grade Level:</strong> <%= registration.grade_level %></li>
                    <li class="list-group-item"><strong>Birthday:</strong> <%= (new Date(registration.birthday)).toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: 'numeric'}) %></li>
                <li class="list-group-item"><strong>Age:</strong> <%= registration.age %></li>
                <li class="list-group-item"><strong>Sex:</strong> <%= registration.sex %></li>
                <li class="list-group-item"><strong>Religion:</strong> <%= registration.religion %></li>
                <li class="list-group-item"><strong>Current Address:</strong> <%= registration.current_address %></li>
                <li class="list-group-item"><strong>IP Community:</strong> <%= registration.ip_community %> <% if (registration.ip_community_specify) { %> (<%= registration.ip_community_specify %>) <% } %></li>
                <li class="list-group-item"><strong>PWD:</strong> <%= registration.pwd %> <% if (registration.pwd_specify) { %> (<%= registration.pwd_specify %>) <% } %></li>
                <li class="list-group-item"><strong>Father's Name:</strong> <%= registration.father_name %></li>
                <li class="list-group-item"><strong>Mother's Name:</strong> <%= registration.mother_name %></li>
                <li class="list-group-item"><strong>Legal Guardian's Name:</strong> <%= registration.guardian_name %></li>
                <li class="list-group-item"><strong>Contact Number:</strong> <%= registration.contact_number %></li>
                <li class="list-group-item"><strong>Registration Date (declared):</strong> <%= registration.registration_date ? new Date(registration.registration_date).toLocaleDateString('en-PH', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Manila' }) : 'N/A' %></li>
                <li class="list-group-item"><strong>Submitted At:</strong> <%= registration.created_at ? new Date(registration.created_at).toLocaleString('en-PH', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: 'Asia/Manila' }) : 'N/A' %></li>
                                                    <li class="list-group-item"><strong>Printed Name:</strong> <%= registration.printed_name ? registration.printed_name : 'Not provided' %></li>
                                                    <li class="list-group-item"><strong>Signature Image:</strong> <% if (registration.signature_image_path) { %><br><img src="<%= registration.signature_image_path %>" alt="Signature" style="max-width:300px; border:1px solid #dc2626; border-radius:8px;"/><% } else { %>No signature uploaded<% } %></li>
            </ul>
        </div>
    </div>
    <script>
                        // Keep reference to edit modal to re-open after e-sign modal actions
                        const editModalEl = document.getElementById('editModal');
                        const editModal = new bootstrap.Modal(editModalEl);
                        let openedEsignFromEdit = false;

                        // Signature change toggle
                const changeSignatureSwitch = document.getElementById('changeSignatureSwitch');
                const openEsignBtn = document.getElementById('openEsignBtn');
                const signatureDataInput = document.getElementById('signatureData');
                const esignStatus = document.getElementById('esignStatus');
                const esignPreviewWrap = document.getElementById('esignPreviewWrap');
                const esignPreview = document.getElementById('esignPreview');
                        const signatureFile = document.getElementById('signatureFile');

                changeSignatureSwitch.addEventListener('change', () => {
                    const enabled = changeSignatureSwitch.checked;
                    openEsignBtn.disabled = !enabled;
                            signatureFile.disabled = !enabled;
                    if (!enabled) {
                        signatureDataInput.value = '';
                                signatureFile.value = '';
                        esignPreviewWrap.style.display = 'none';
                        esignStatus.textContent = 'Keeping existing signature';
                        esignStatus.classList.remove('text-success');
                        esignStatus.classList.add('text-muted');
                    } else {
                        esignStatus.textContent = 'No new signature selected yet';
                        esignStatus.classList.remove('text-muted');
                        esignStatus.classList.add('text-warning');
                    }
                });

                // Simple signature pad
                const canvas = document.getElementById('signatureCanvas');
                const ctx = canvas.getContext('2d');
                let drawing = false;

                function getPos(e) {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - rect.left, y: clientY - rect.top };
                }

                function startDraw(e) { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); e.preventDefault(); }
            function draw(e) { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke(); e.preventDefault(); }
                function endDraw() { drawing = false; }

                canvas.addEventListener('mousedown', startDraw);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('mouseleave', endDraw);
                canvas.addEventListener('touchstart', startDraw, { passive: false });
                canvas.addEventListener('touchmove', draw, { passive: false });
                canvas.addEventListener('touchend', endDraw);

                document.getElementById('clearSignatureBtn').addEventListener('click', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });

                        // When opening E-Sign modal, mark that it came from edit modal
                        openEsignBtn.addEventListener('click', () => { openedEsignFromEdit = true; });

                        document.getElementById('doneSignatureBtn').addEventListener('click', () => {
                    const dataUrl = canvas.toDataURL('image/png');
                    signatureDataInput.value = dataUrl;
                            // If using canvas, clear any selected file to avoid conflicts
                            signatureFile.value = '';
                    esignPreview.src = dataUrl;
                    esignPreviewWrap.style.display = 'block';
                    esignStatus.textContent = 'New signature attached';
                    esignStatus.classList.remove('text-warning');
                    esignStatus.classList.add('text-success');
                    // Close modal
                    const modalEl = document.getElementById('signatureModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                            // Re-open edit modal
                            if (openedEsignFromEdit) {
                                editModal.show();
                                openedEsignFromEdit = false;
                            }
                });

                        // File upload flow for signature
                        signatureFile.addEventListener('change', (e) => {
                            const file = e.target.files && e.target.files[0];
                            if (!file) return;
                            // Clear canvas data if any
                            signatureDataInput.value = '';
                            // Preview the selected image
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                esignPreview.src = ev.target.result;
                                esignPreviewWrap.style.display = 'block';
                                esignStatus.textContent = 'Signature image selected';
                                esignStatus.classList.remove('text-warning');
                                esignStatus.classList.add('text-success');
                            };
                            reader.readAsDataURL(file);
                        });

                        // Ensure when signature modal is closed by X/Cancel, we return to edit modal
                        const signatureModalEl = document.getElementById('signatureModal');
                        signatureModalEl.addEventListener('hidden.bs.modal', () => {
                            if (openedEsignFromEdit) {
                                editModal.show();
                                openedEsignFromEdit = false;
                            }
                        });
    </script>
</div>
</body>
</html>
